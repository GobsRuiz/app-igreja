rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPERS =====

    /**
     * Obtém role do token (Custom Claim)
     * Segurança: Não pode ser falsificado pelo cliente
     */
    function getRole() {
      return request.auth.token.role;
    }

    /**
     * Verifica se usuário está autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Verifica se é admin ou superadmin
     */
    function isAdmin() {
      return isAuthenticated() && getRole() in ['admin', 'superadmin'];
    }

    /**
     * Verifica se é superadmin
     */
    function isSuperAdmin() {
      return isAuthenticated() && getRole() == 'superadmin';
    }

    /**
     * Verifica se é o próprio usuário
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ===== REGRAS =====

    /**
     * USUÁRIOS
     * - Todos autenticados podem ler
     * - Apenas o próprio usuário pode atualizar seus dados (exceto role)
     * - Apenas superadmin pode alterar role
     */
    match /users/{userId} {
      allow read: if isAuthenticated();

      // Próprio usuário pode atualizar (exceto role)
      allow update: if isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);

      // Superadmin pode atualizar role
      allow update: if isSuperAdmin();

      // Apenas sistema cria usuários (via signup)
      allow create: if isAuthenticated() && isOwner(userId);

      // Apenas superadmin deleta usuários
      allow delete: if isSuperAdmin();
    }

    /**
     * EVENTOS
     * - Todos autenticados podem ler
     * - Apenas admin pode criar/editar/deletar
     *
     * PROTEÇÃO DO CAMPO STATUS:
     * - Campo 'status' só pode ser alterado por admins
     * - Cloud Function (updateFinishedEvents) roda com admin privileges, então pode atualizar
     * - Usuários regulares NÃO podem modificar status, mesmo com permissão de update
     *
     * Validação extra: Garante que se houver update de status, deve ser admin
     */
    match /events/{eventId} {
      allow read: if isAuthenticated();

      // Create: apenas admin
      allow create: if isAdmin();

      // Update: apenas admin (inclui todas as modificações, incluindo status)
      // Cloud Function roda como admin, então updateFinishedEvents funciona
      allow update: if isAdmin();

      // Delete: apenas admin
      allow delete: if isAdmin();
    }

    /**
     * CATEGORIAS
     * - Todos autenticados podem ler
     * - Apenas admin pode criar/editar/deletar
     */
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    /**
     * LOCAIS
     * - Todos autenticados podem ler
     * - Apenas admin pode criar/editar/deletar
     */
    match /locations/{locationId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    /**
     * FALLBACK: Bloqueia tudo que não foi explicitamente permitido
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
